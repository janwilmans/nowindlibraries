			include "opl4.inc"
			
			output "detect.bin"

; Puyo check on address 5DC2  
; insert this code 	CALL	&h5DDC
;			10  nops


; Port patches


;000B0AA1: C4 C0
;000B0AA6: C5 C1
;000B0AB0: C4 C0
;000B0AB5: C5 C1
;000B0AC4: C4 C0
;000B0AC9: C5 C1
;000B0AD3: C4 C0
;000B0AD8: C5 C1
;000B0AE2: C4 C0
;000B0AE7: C5 C1
;000B0AF1: C4 C0
;000B0AF6: C5 C1
;000B0B0C: C4 C0
;000B0B0F: C5 C1
;000B0B21: C4 C0
;000B0B24: C5 C1
;000B0B3E: C4 C0
;000B0B52: C5 C1
;000B0B65: C4 C0
;000B0B68: C5 C1
;000B0B87: C4 C0
;000B0B8A: C5 C1
;000B0B9C: C4 C0
;000B0BA6: C5 C1
;000B0BB9: C5 C1
;000B0BC8: C4 C0
;000B0BCB: C5 C1
;000B0BD2: C5 C1
;000B0BFE: C4 C0
;000B0C06: C5 C1
;000B0C15: C5 C1
;000B0C2D: C4 C0
;000B0C3A: C5 C1
;000B0C54: C4 C0
;000B0C57: C5 C1
;000B1775: C4 C0
;000B1778: C5 C1
;000B17CB: C4 C0
;000B17CE: C5 C1
;000B17F9: C4 C0
;000B17FC: C5 C1

; Put this on address 5DDC
Detect:
; Output NC = No opl4 detected, C = opl4 found and put in opl2 mode
			LD	A,OPL4_REG_EXPANSION
			OUT	(OPL4_FM1_REG_SELECT),A
			PUSH	BC
			POP	BC
			LD	A,OPL4_ENABLE_OPL3_REG|OPL4_ENABLE_OPL4_REG
			OUT	(OPL4_FM1_REG_DATA),A
			PUSH	BC
			POP	BC
			IN	A,(OPL4_FM1_REG_DATA)
			CP	A,OPL4_ENABLE_OPL3_REG|OPL4_ENABLE_OPL4_REG
			LD	A,0	; Set opl mode
			OUT	(OPL4_FM1_REG_DATA),A
			SCF
			RET	Z
			CCF
			RET